<!DOCTYPE html>
<html lang = "en">
  <head>
    <title>Tutor4u - Home</title>
    <meta charset = "utf-8" />
    <link rel="stylesheet" type="text/css" href="css/main.css">

      <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
      <script  src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>

      <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>

      <!-- Add Firebase products that you want to use -->
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-messaging.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>


      <script src="app.js"></script>

      <script>
        var isLoggedIn;
        var listInfo = [];
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
              isLoggedIn = true;
            document.getElementById("mainButton").innerHTML = "<button id = \"logout\" onclick = \"signUserOut()\">Logout</button>";
            document.getElementById("toggleMessageUser").innerHTML = "<p style =\"color: #CCC\">User is currently signed in</p>";

            var info = database.ref("auth/users/" + user.uid);
            info.on('value', obtainData, errData);

            function obtainData(pData)
            {
                var userData = pData.val();
                var userDataKeys = Object.keys(userData);

                for (var i = 0; i < userDataKeys.length; i++)
                {
                    var userK = userDataKeys[i];
                    listInfo.push(userData[userK]);
                }

                changeUserGreeting();

            }

            function changeUserGreeting()
            {
                document.getElementById("testerWelcome").innerHTML = "Welcome " + listInfo[0] + "! You are a gr." + listInfo[2] + " " + listInfo[3] + " and your email is " + listInfo[1];
            }

            function errData(err)
            {
                console.log("Error!");
                console.log(err);
            }


          } else {
            // No user is signed in.
              isLoggedIn = false;
            document.getElementById("mainButton").innerHTML = "<a href = \"login.html\"><button id = \"get-started\">Get started</button></a>";
              document.getElementById("toggleMessageUser").innerHTML = "<input type = \"text\" id = \"messageUser\"></p>";
          }
          document.getElementById("loading").style.display = "none";
        });
      </script>

      <script>
          function signUserOut()
          {
                  firebase.auth().signOut().then(function() {
                      // Sign-out successful.
              }).catch(function(error) {
                  // An error happened.
              });
          }
          function fireWrite(thingToChange, changeTo) {
              database.ref(thingToChange +  '/').set({
                  thingToChange: changeTo
              });
          }
          var temp = "Start of messages! <br>";
          function updateMessage()
          {
              temp = document.getElementById("message").innerHTML + "<br>";
              // Write the data to firebase for messaging
              if (isLoggedIn)
              {
                  var messageSender = String(listInfo[0]);
              }
              else
              {
                  var messageSender = String(document.getElementById("messageUser").value);
              }
                  database.ref('message/').set({
                      userOrSomething: messageSender,
                      payloadOrSomething: document.getElementById("messageSent").value
                  });
              document.getElementById("messageSent").value = "";
              //
          }
          var messageRef = firebase.database().ref("message/");
          messageRef.on('value', getData, errData);
          function getData(data)
          {
              var temp = document.getElementById("message").innerHTML + "<br>";
              var message = data.val();
              var key = Object.keys(message);
              var realValues = [];
              for (var i = 0; i < key.length; i++)
              {
                  realValues[i] = message[key[i]];
                  realValues[i] = realValues[i].replace(/</g, "< ")
              }

              document.getElementById("message").innerHTML = temp + " " + realValues[1] + ": " + realValues[0];
              document.getElementById('message').scrollTop = document.getElementById('message').scrollHeight;
          }
          function errData(err)
          {
              console.log("Error!");
              console.log(err);
          }
      </script>

  </head>
  <body>
      <nav>
        <ul>
          <li class = "left-nav"><a href = "index.html"><h1>Tutor for you</h1></a></li>
          <li class = "left-nav"><a href = "tutoring.html"><h2>Tutoring</h2></a></li>
          <li class = "left-nav"><a href = "options.html"><h2>Options</h2></a></li>
          <li class = "left-nav"><a href = "about.html"><h2>About</h2></a></li>
          <li id = "mainButton"></li>
        </ul>
      </nav>
      <p id = "message"> Messages Go Here </p>
      <br>
      <br>
      <p style = "display:inline-block;">Name:&nbsp</p><p id = "toggleMessageUser" style = "display:inline-block;"><input type = "text" id = "messageUser"></p>
      <p style = "display: inline-block;">&nbsp | Message:</p>
      <input type = "text" id = "messageSent" />
      <button onclick = "updateMessage();">Submit Message</button>
      <br>
      <p id = "testerWelcome"></p>
      <div id = "loading">
      </div>
  </body>
</html>
