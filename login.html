<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script  src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>


    <script src="app.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script>
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                try
                {
                    var temp2 = (user.email).split("@");
                    var tempRef = database.ref("auth/");
                    tempRef.on('value', getData, errData);
                    function getData(data)
                    {
                        var userInfo = data.val();
                        var keys = Object.keys(userInfo);


                        for (var i = 0; i < keys.length; i++)
                        {
                            var k = keys[i];
                            if (k === temp2[0])
                            {
                                database.ref("auth/users/" + user.uid + "/").set({
                                    displayName: userInfo[k].displayName,
                                    email: userInfo[k].email,
                                    grade: userInfo[k].grade,
                                    role : userInfo[k].role
                                });
                                database.ref("auth/" + temp2[0]).remove();
                            }
                        }
                    }

                    function errData(err)
                    {
                        console.log("Error!");
                        console.log(err);
                    }
                }catch(err)
                {
                    console.log(err);
                }


            else {
                // No user is signed in.
            }
        });

        function login()
        {
            var userEmail = document.getElementById("email_field").value;
            var userPass = document.getElementById("password_field").value;

            firebase.auth().signInWithEmailAndPassword(userEmail, userPass).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                alert("Sorry, " + errorMessage);
                // ...
            });
        }

        function signUp()
        {
            var userEmail = document.getElementById("email_field").value;
            var userPass = document.getElementById("password_field").value;

            // sign in
            var promise = firebase.auth().createUserWithEmailAndPassword(userEmail, userPass);
            promise.then(function(authData) {// when email is successfully sent
                authData.user.sendEmailVerification();
                //alert("Verification email sent!");
            })

                .catch(function(error) {
                    // Handle Errors here.
                    alert("Sorry, " + error.message);
                });
            postSignUp();
        }

        function postSignUp()
        {
            var temp1 = document.getElementById("email_field").value.split("@");
            database.ref("auth/" + temp1[0] + "/").set({
                displayName: document.getElementById("name_field").value,
                email: document.getElementById("email_field").value,
                grade: document.getElementById("grade_field").value,
                role : document.getElementById("role_field").value
            });
        }

        function signUpSetup()
        {
            document.getElementById("actionLink").innerHTML = "<a onclick = \"loginSetup();\" id = \"toggleLink\">Login</a>";
            document.getElementById("actionButton").innerHTML = "<button onclick = \"signUp()\" id = \"loginButton\">Sign Up</button>";
            $("#displayNameToggle").show();
            $("#gradeToggle").show();
            $("#roleToggle").show();
            //document.getElementById("displayNameToggle").innerHTML = "Display Name: &nbsp;<input type = \"text\" name = \"displayName\" id = \"name_field\"/>";
            //document.getElementById("gradeToggle").innerHTML = "Grade: &nbsp;<input type = \"number\" name = \"grade\" id = \"grade_field\"/>";
            //document.getElementById("roleToggle").innerHTML = "Role: &nbsp;<input type = \"text\" name = \"role\" id = \"role_field\"/>";
        }

        function loginSetup()
        {
            document.getElementById("actionLink").innerHTML = "<a onclick = \"signUpSetup();\" id = \"toggleLink\">Sign Up</a>";
            document.getElementById("actionButton").innerHTML = "<button onclick = \"login()\" id = \"loginButton\">Login</button>";
            $("#displayNameToggle").hide();
            $("#gradeToggle").hide();
            $("#roleToggle").hide();
            //document.getElementById("displayNameToggle").innerHTML = "";
            //document.getElementById("gradeToggle").innerHTML = "";
            //document.getElementById("roleToggle").innerHTML = "";
        }
        $(document).ready(() => {
            $("#displayNameToggle").hide();
            $("#gradeToggle").hide();
            $("#roleToggle").hide();
        });

    </script>
</head>
<body>

<nav id = "login-nav">
    <button id = "input-home">Home</button>
</nav>

<div id = "input-form">

    <p class = "input_field">Email: &nbsp;<input type = "text" name = "email" id = "email_field"/><br></p>


    <p class = "input_field">Password: &nbsp;<input type = "password" name = "password" id = "password_field"/><br></p>


    <p class = "input_field" id = "displayNameToggle">Display Name: &nbsp;<input type = "text" name = "displayName" id = "name_field"/><br></p>


    <p class = "input_field" id = "gradeToggle">Grade: &nbsp;<input type = "number" name = "grade" id = "grade_field"/><br></p>


    <p class = "input_field" id = "roleToggle">Role: &nbsp;<input type = "text" name = "role" id = "role_field"/></p>

    <p class = "input_field" id = "actionLink"><a onclick = "signUpSetup();" id = "toggleLink">Sign Up</a></p>
    <p class = "input_field" id = "actionButton"><button onclick = "login()" id = "loginButton">Log In</button></p>
</div>
</body>
</html>