<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script  src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>

    <script src="app.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script>
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                //Runs when user is logged in
                try
                {
                    //Get temporary database reference with first part of email
                    var temp2 = (user.email).split("@");
                    //Setting reference to write new and permanent file using user id
                    var tempRef = database.ref("auth/");
                    //Start writing process
                    tempRef.on('value', getUserData, errData);
                    //Function to parse data
                    function getUserData(data)
                    {
                        //Extracting data from firebase database as an object
                        var userInfo = data.val();
                        //Obtaining keys for the data
                        var keys = Object.keys(userInfo);

                        //For loop to iterate through every key in the directory
                        for (var i = 0; i < keys.length; i++)
                        {
                            //Sets variable k to the current key
                            var k = keys[i];
                            //Checks to see if the key is equal to the temporary database
                            if (k === temp2[0])
                            {
                                //Creates new directory in auth node called the user id and writes all basic user info in it
                                database.ref("auth/users/" + user.uid + "/").set({
                                    displayName: userInfo[k].displayName,
                                    email: userInfo[k].email,
                                    grade: userInfo[k].grade,
                                    role : userInfo[k].role
                                });
                                //Removes old temporary node
                                database.ref("auth/" + temp2[0]).remove();
                            }
                        }
                    }
                }catch(err)
                {
                    console.log(err);
                }
                //Waits for 2 seconds to ensure database writing is successful then redirects user to email verification page
                setTimeout(function(){window.location.replace("verify.html");}, 2000)
            } else {
                // Runs when no user is signed in.
            }
        });

        //Error function for errors that occur while reading data
        function errData(err)
        {
            console.log("Error!");
            console.log(err);
        }

        //Function that runs when the login button is clicked
        function login()
        {
            //Gets values of email and password text inputs
            var userEmail = document.getElementById("email_field").value;
            var userPass = document.getElementById("password_field").value;

            //Starts firebase sign in process
            firebase.auth().signInWithEmailAndPassword(userEmail, userPass).catch(function(error) {
                //Handle Errors here
                var errorCode = error.code;
                var errorMessage = error.message;
                alert("Sorry, " + errorMessage);
            });
        }

        //Function that runs after sign up button is clicked
        function signUp()
        {
            //Gets values of email and password text inputs
            var userEmail = document.getElementById("email_field").value;
            var userPass = document.getElementById("password_field").value;

            //Create a new user using email and password credentials
            var promise = firebase.auth().createUserWithEmailAndPassword(userEmail, userPass);
            promise.then(function(authData) {// Runs after user is created
                authData.user.sendEmailVerification(); // Send the user a verification email
            })

                .catch(function(error) { //Catches errors that occur while sending email
                    //Handle Errors here
                    alert("Sorry, " + error.message);
                });
            //Runs post sign up procedures
            postSignUp();
        }

        //Runs after new user has been created
        function postSignUp()
        {
            //Creates temporary directory variable using the first part of the users email
            var temp1 = document.getElementById("email_field").value.split("@");

            //Writes basic user info to the temporary directory
            database.ref("auth/" + temp1[0] + "/").set({
                displayName: document.getElementById("name_field").value,
                email: document.getElementById("email_field").value,
                grade: document.getElementById("grade_field").value,
                role : document.getElementById("role_field").value
            });
        }

        //Runs after the sign up switch link is clicked
        function signUpSetup() {
            //Swaps the link and button names to match the new form
            document.getElementById("actionLink").innerHTML = "<a onclick = \"loginSetup();\" id = \"toggleLink\">Login</a>";
            document.getElementById("actionButton").innerHTML = "<button onclick = \"signUp()\" id = \"loginButton\">Sign Up</button>";

            //Makes additional 3 text inputs visible to the user necessary to sign up as a new user
            $("#displayNameToggle").show();
            $("#gradeToggle").show();
            $("#roleToggle").show();
        }

        function loginSetup()
        {
            //Swaps the link and button names to match the new form
            document.getElementById("actionLink").innerHTML = "<a onclick = \"signUpSetup();\" id = \"toggleLink\">Sign Up</a>";
            document.getElementById("actionButton").innerHTML = "<button onclick = \"login()\" id = \"loginButton\">Login</button>";

            //Hides the 3 text inputs that the user doesn't need when logging in
            $("#displayNameToggle").hide();
            $("#gradeToggle").hide();
            $("#roleToggle").hide();
        }
        $(document).ready(() => {
            //Hides the 3 text inputs when website is first rendered
            $("#displayNameToggle").hide();
            $("#gradeToggle").hide();
            $("#roleToggle").hide();
        });

    </script>
</head>
<body>

<nav id = "login-nav">
    <button id = "input-home">Home</button>
</nav>

<div id = "input-form">

    <p class = "input_field">Email: &nbsp;<input type = "text" name = "email" id = "email_field"/><br></p>


    <p class = "input_field">Password: &nbsp;<input type = "password" name = "password" id = "password_field"/><br></p>


    <p class = "input_field" id = "displayNameToggle">Display Name: &nbsp;<input type = "text" name = "displayName" id = "name_field"/><br></p>


    <p class = "input_field" id = "gradeToggle">Grade: &nbsp;<input type = "number" name = "grade" id = "grade_field"/><br></p>


    <p class = "input_field" id = "roleToggle">Role: &nbsp;<input type = "text" name = "role" id = "role_field"/></p>

    <p id = "actionLink"><a onclick = "signUpSetup();" id = "toggleLink">Sign Up</a></p>
    <p id = "actionButton"><button onclick = "login()" id = "loginButton">Log In</button></p>
</div>
</body>
</html>